# Enhanced daemon mode configuration
# Demonstrates all 8 improvements:
# 1. Concurrent processing
# 2. File completion detection
# 3. Statistics tracking
# 4. Retry mechanism
# 5. Health check & control API
# 6. Notifications
# 7. File deduplication
# 8. Better error context

command: daemon
daemon: true

# ============================================================================
# DIRECTORIES
# ============================================================================

# Directory to watch for incoming disk files
# Supports: .vmdk, .ova, .ovf, .vhd, .vhdx, .raw, .img, .ami
watch_dir: /var/lib/hyper2kvm/queue

# Output directory for converted VMs (organized by date)
output_dir: /var/lib/hyper2kvm/output

# Working directory for temporary files
workdir: /var/lib/hyper2kvm/work

# ============================================================================
# CONCURRENT PROCESSING (Improvement #1)
# ============================================================================

# Process up to 3 VMs simultaneously
# Adjust based on CPU/memory/disk I/O capacity
max_concurrent_jobs: 3

# ============================================================================
# FILE COMPLETION DETECTION (Improvement #2)
# ============================================================================

# Wait up to 30 seconds for file size to stabilize
# Prevents processing incomplete files
file_stable_timeout: 30

# ============================================================================
# STATISTICS TRACKING (Improvement #3)
# ============================================================================

# Statistics automatically saved to: {output_dir}/.daemon/stats.json
# Send SIGUSR1 to daemon PID to print stats: kill -USR1 <pid>
# Prints hourly summary to logs automatically

# ============================================================================
# RETRY MECHANISM (Improvement #4)
# ============================================================================

retry_policy:
  enabled: true
  max_retries: 3
  retry_delay: 300  # 5 minutes
  backoff_multiplier: 2.0  # Exponential backoff (5m, 10m, 20m)

# ============================================================================
# HEALTH CHECK & CONTROL API (Improvement #5)
# ============================================================================

# Control socket automatically created at: {output_dir}/.daemon/control.sock
# Use: python3 -m hyper2kvm.cli.daemon_ctl status
# Commands: status, stats, pause, resume, drain, stop

# ============================================================================
# NOTIFICATIONS (Improvement #6)
# ============================================================================

notifications:
  enabled: true

  # When to notify
  on_success: false  # Don't spam on every success
  on_failure: true   # Alert on failures
  on_stalled: true   # Alert if daemon stalled (no activity > 60min)

  # Webhook notifications (Slack example)
  webhook_url: "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
  webhook_type: "slack"  # Options: slack, discord, generic

  # Email notifications (optional)
  email_enabled: false
  email_smtp_host: "smtp.gmail.com"
  email_smtp_port: 587
  email_from: "hyper2kvm@example.com"
  email_to: "admin@example.com"
  email_username: "hyper2kvm@example.com"
  email_password: "app-specific-password"

# ============================================================================
# FILE DEDUPLICATION (Improvement #7)
# ============================================================================

enable_deduplication: true
deduplication_use_md5: false  # Set true for hash-based dedup (slower but more reliable)

# Deduplication database: {output_dir}/.daemon/deduplication.db
# Tracks processed files to avoid reprocessing

# ============================================================================
# BETTER ERROR CONTEXT (Improvement #8)
# ============================================================================

# Failed files moved to: {watch_dir}/.errors/
# Error details saved to: {watch_dir}/.errors/filename.error.json
# Includes:
#   - Error message and phase
#   - Full traceback
#   - Actionable suggestions
#   - System info (disk space, etc.)

# ============================================================================
# ARCHIVING
# ============================================================================

# Archive successfully processed files (default: true)
# Organized by date: {watch_dir}/.processed/YYYY-MM-DD/
archive_processed: true

# ============================================================================
# CONVERSION SETTINGS
# ============================================================================

flatten: true
out_format: qcow2
compress: true
compress_level: 6
enable_recovery: true

# ============================================================================
# GUEST OS FIXES
# ============================================================================

fstab_mode: stabilize-all
regen_initramfs: true
update_grub: true

# Windows-specific
win_virtio: true
win_hyperv: true

# ============================================================================
# LOGGING
# ============================================================================

log_file: /var/log/hyper2kvm/daemon.log
verbose: 2  # 0=errors only, 1=info, 2=debug, 3=trace

# ============================================================================
# LIBVIRT DOMAIN XML
# ============================================================================

emit_domain_xml: true
vm_memory: 4096
vm_vcpus: 2
vm_uefi: false

# ============================================================================
# USAGE EXAMPLES
# ============================================================================

# Run manually:
#   sudo python3 -m hyper2kvm --config daemon-enhanced.yaml

# Run with systemd:
#   sudo cp daemon-enhanced.yaml /etc/hyper2kvm/production.yaml
#   sudo systemctl enable --now hyper2kvm@production.service

# Control daemon:
#   python3 -m hyper2kvm.cli.daemon_ctl --output-dir /var/lib/hyper2kvm/output status
#   python3 -m hyper2kvm.cli.daemon_ctl pause
#   python3 -m hyper2kvm.cli.daemon_ctl resume
#   python3 -m hyper2kvm.cli.daemon_ctl stats --json

# View stats:
#   cat /var/lib/hyper2kvm/output/.daemon/stats.json

# View errors:
#   ls -lh /var/lib/hyper2kvm/queue/.errors/
#   cat /var/lib/hyper2kvm/queue/.errors/failed-vm.vmdk.error.json
