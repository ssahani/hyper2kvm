# ============================================
# Complete Workflow: vSphere â†’ libvirt (Ubuntu 20.04 LTS)
# ============================================
# Description: Export Ubuntu 20.04 VM from vSphere via govc and prepare for libvirt
# Use Case: Production migration of Ubuntu 20.04 VMs from VMware to KVM
# Prerequisites:
#   - govc installed and configured
#   - vCenter credentials
#   - Network access to vCenter
#   - Target output directory with sufficient space
# ============================================

# Command
cmd: vsphere

# vSphere Connection
vcenter: vcenter.example.com
username: administrator@vsphere.local
password_file: ~/.vcenter_password  # Store password securely, not in YAML
datacenter: Production-DC
cluster: Compute-Cluster

# VM Selection
vm_name: ubuntu-2004-web-server
# Alternative: Use vm_uuid for exact match
# vm_uuid: 502d5b64-0a7e-b2a5-45f9-065cbf375a77

# vSphere Action
vs_action: export

# Export Method (govc-based)
export_method: govc
export_format: ova  # or vmdk for individual disks

# Snapshot Handling
create_snapshot: true
snapshot_name: pre-migration-$(date +%Y%m%d-%H%M%S)
snapshot_description: Snapshot before KVM migration
snapshot_quiesce: true  # VSS quiesce for consistent snapshot

# Disk Processing
flatten: true  # Collapse snapshot chains
compress: true  # Enable qcow2 compression

# Ubuntu 20.04 Specific Fixes
fix_fstab: true
fix_grub: true
fix_initramfs: true
fix_network: true
remove_vmware_tools: true

# Network Configuration
# Ubuntu 20.04 uses netplan
network_config_type: netplan
network_fix_level: full  # clean, minimal, full
remove_mac_binding: true
setup_dhcp: true

# Bootloader Configuration
bootloader_type: grub2
firmware_type: auto  # auto-detect BIOS or UEFI
regenerate_grub: true
update_grub_config: true

# Kernel/Initramfs
update_initramfs: true
install_virtio_modules: true

# System Cleanup
clean_cloud_init: false  # Keep cloud-init for Ubuntu
clean_ssh_keys: false  # Preserve SSH keys
clean_machine_id: true  # Regenerate on first boot

# Output Configuration
to_output: /data/kvm/ubuntu-2004-web-server.qcow2
output_format: qcow2
output_dir: /data/kvm/

# libvirt Domain Generation
generate_libvirt_xml: true
libvirt_xml_path: /data/kvm/ubuntu-2004-web-server.xml
libvirt_domain_name: ubuntu-2004-web-server

# libvirt VM Configuration
memory_mb: 4096
vcpus: 4
cpu_mode: host-passthrough
machine_type: q35

# libvirt Disk Configuration
disk_bus: virtio
disk_cache: none
disk_io: native

# libvirt Network Configuration
network_type: bridge
network_bridge: virbr0
network_model: virtio

# Additional Devices
enable_serial_console: true
enable_vnc: true
vnc_listen: 127.0.0.1

# Validation
libvirt_test: true
qemu_test: false
dry_run: false

# Reporting
report: /var/log/migrations/ubuntu-2004-web-server-$(date +%Y%m%d).md
log_level: INFO
verbose: true

# Recovery
enable_recovery: true
recovery_checkpoint_dir: /tmp/hyper2kvm-recovery

# Post-Migration Actions
post_migration_script: |
  #!/bin/bash
  # Import to libvirt
  virsh define /data/kvm/ubuntu-2004-web-server.xml

  # Set autostart
  virsh autostart ubuntu-2004-web-server

  # Start VM
  virsh start ubuntu-2004-web-server

  # Wait for boot
  sleep 30

  # Check if VM is running
  virsh list | grep ubuntu-2004-web-server
