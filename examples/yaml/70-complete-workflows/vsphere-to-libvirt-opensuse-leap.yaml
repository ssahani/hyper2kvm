# ============================================
# Complete Workflow: vSphere â†’ libvirt (openSUSE Leap 15.5)
# ============================================
# Description: Export openSUSE Leap VM from vSphere and prepare for libvirt/KVM
# Use Case: Enterprise SUSE migration
# Prerequisites:
#   - govc installed
#   - vCenter credentials
#   - openSUSE Leap 15.5 VM
# ============================================

cmd: vsphere

# vSphere Connection
vcenter: vcenter.example.com
username: administrator@vsphere.local
password_file: ~/.vcenter_password
datacenter: Production-DC
cluster: SUSE-Cluster

# VM Selection
vm_name: opensuse-leap-15-server
# Alternative: vm_path: /Production-DC/vm/SUSE/opensuse-leap-15-server

# vSphere Export
vs_action: export
export_method: govc
export_format: ova

# Snapshot Configuration
create_snapshot: true
snapshot_name: kvm-migration-snapshot
snapshot_description: Snapshot for KVM migration - $(date +%Y-%m-%d)
snapshot_memory: false
snapshot_quiesce: true
delete_snapshot_after: true

# Disk Processing
flatten: true
compress: true
disk_format: qcow2

# openSUSE Leap Specific Fixes
fix_fstab: true
fix_grub: true
fix_initramfs: true
fix_network: true
remove_vmware_tools: true

# Network Configuration (openSUSE uses wicked or NetworkManager)
network_config_type: wicked  # or networkmanager
network_fix_level: full
remove_mac_binding: true
setup_dhcp: true
preserve_static_ip: false
network_config_path: /etc/sysconfig/network

# Bootloader Configuration (GRUB2)
bootloader_type: grub2
firmware_type: uefi  # openSUSE Leap default
regenerate_grub: true
update_grub_config: true
grub_timeout: 8

# Initramfs Configuration (openSUSE uses dracut)
update_initramfs: true
dracut_force_rebuild: true
install_virtio_modules: true
dracut_add_drivers:
  - virtio
  - virtio_blk
  - virtio_scsi
  - virtio_net
  - virtio_pci
  - virtio_balloon

# System Configuration
clean_ssh_keys: false
clean_machine_id: true
preserve_hostname: true
timezone: Europe/Berlin

# Output Configuration
to_output: /data/kvm/opensuse-leap-15-server.qcow2
output_format: qcow2
output_dir: /data/kvm/

# libvirt Domain XML Generation
generate_libvirt_xml: true
libvirt_xml_path: /data/kvm/opensuse-leap-15-server.xml
libvirt_domain_name: opensuse-leap-15-server

# libvirt Hardware Configuration
memory_mb: 4096
vcpus: 4
cpu_mode: host-model
cpu_topology:
  sockets: 1
  cores: 4
  threads: 1
machine_type: q35

# UEFI Configuration
firmware_type: uefi
uefi_loader: /usr/share/qemu/ovmf-x86_64-code.bin
uefi_nvram_template: /usr/share/qemu/ovmf-x86_64-vars.bin
secure_boot: false

# Storage Configuration
disk_bus: virtio
disk_cache: none
disk_io: native
disk_discard: unmap

# Network Configuration
network_type: bridge
network_bridge: br0
network_model: virtio

# Console/Graphics
enable_serial_console: true
enable_vnc: true
vnc_listen: 0.0.0.0
vnc_password_required: false

# QEMU Guest Agent
qemu_guest_agent: true

# Validation
libvirt_test: true
boot_timeout: 300
validate_network: true

# Reporting
report: /var/log/migrations/opensuse-leap-$(date +%Y%m%d-%H%M%S).md
log_level: INFO
verbose: true

# Recovery Configuration
enable_recovery: true
recovery_checkpoint_dir: /tmp/hyper2kvm-checkpoints

# Post-Migration Script
post_migration_script: |
  #!/bin/bash
  set -e

  # Import domain
  virsh define /data/kvm/opensuse-leap-15-server.xml

  # Start VM
  virsh start opensuse-leap-15-server

  # Wait for boot
  echo "Waiting for openSUSE Leap to boot..."
  sleep 45

  # Check VM status
  virsh list | grep opensuse-leap-15-server

  echo "openSUSE Leap migration complete"
  echo "Connect via: virsh console opensuse-leap-15-server"
  echo "YaST2 may need to be reconfigured for network"
